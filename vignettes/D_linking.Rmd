---
title: "Linking information between FHIR resources"
author: "Vincent J. Carey, stvjc at channing.harvard.edu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Linking information between FHIR resources}
  %\VignetteEncoding{UTF-8}
output:
  BiocStyle::html_document:
    highlight: pygments
    number_sections: yes
    theme: united
    toc: yes
---

```{r setup,results="hide",echo=FALSE}
suppressPackageStartupMessages({
suppressMessages({
library(BiocFHIR)
library(DT)
library(jsonlite)
})
})
```

# Introduction

The purpose of this vignette is to provide
details on how FHIR documents are
transformed to graphs in BiocFHIR.

This text uses R commands that will work for an R (version 4.2 or greater) in which
BiocFHIR (version 0.0.14 or greater) has been installed.  The source codes are
always available at [github](https://github.com/vjcitn/BiocFHIR) and may
be available for installation by other means.

# Examining sample data, again

In the "Upper level FHIR concepts" vignette, we used the
following code to get a peek at the information
structure in a single document representing a Bundle
associated with a patient.

```{r takepeek}
tfile = dir(system.file("json", package="BiocFHIR"), full=TRUE)
peek = jsonlite::fromJSON(tfile)
names(peek)
peek$resourceType
names(peek$entry)
length(names(peek$entry$resource))
class(peek$entry$resource)
dim(peek$entry$resource)
head(names(peek$entry$resource))
```

We perform a first stage of transformation with `process_fhir_bundle`:
```{r txpeek}
bu = process_fhir_bundle(tfile)
bu
```

# A graph relating patients to conditions

```{r lkg1}
data(allin)
g = make_condition_graph(allin)
g
names(g)
```

We made a new S3 class to hold the graph with some convenient metadata.
Ultimately that metadata should be bound into the graph itself as nodeData
and edgeData components.

Because basic identifying information is decomposed into components
in FHIR, we have a utility to acquire the patient name for a given bundle.

```{r lkn}
getHumanName(allin[[1]]$Patient)
```

The edges emanating from the node corresponding to this patient are conditions that have
been recorded.  Edges are retrieved using the `edgeL` method.

```{r lke}
nodes(g$graph)[edgeL(g$graph)[["Ankunding277D'Amore443"]]$edges]
```

